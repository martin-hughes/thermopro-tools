# ThermoPro TP25 BLE Protocol documentation

> This has been entirely reverse-engineered by observing a TP25 in action. There may be mistakes! There's also quite
> a bit that I haven't understood yet. Please feel free to submit corrections or additions via a PR.
>
> Expect this document to expand significantly.

## The basics

The TP25 communicates via Bluetooth Low Energy ('BLE'). It exposes two characteristics, one which is writeable and one
which produces notifications. By writing to the writeable one we can control which data comes out by the notifications.

## Terminology

I use BLE terminology liberally without explaining it here. If you're not familiar, I recommend the Nordic Semiconductor
[Bluetooth Low Energy Fundamentals course](https://academy.nordicsemi.com/courses/bluetooth-low-energy-fundamentals/).

Other terms I use:

* Packet: A specific *command* written to the writeable characteristic, or *value* read from the notifiable one.
  I guess these aren't exactly packets in the normal networking sense, but I think it gives us the right idea.
* Command: A value written to the writable characteristic. I describe this as a command because it appears to tell the
  thermometer what data to send back.
* Value: If used in the context of the notifiable characteristic, the data that is read from the characteristic, which
  has been sent by the thermometer in response to a command.
* Response: Another shorthand for the value sent by the thermometer.
* TLVC, TLVC format: Shorthand for "type, length, value, checksum", as detailed [here](./common-info.md#tlvc-format).

## Data flow

As far as I can tell, the thermometer will normally only send notifications in response to a command. So, broadly
speaking, the normal data flow is:

* Send command
* Wait for notification
* Read response
* Repeat from top

The first byte of each response is usually the same as the first byte of the preceding command, although sometimes
the sequence is not quite correct. When responses do not immediately follow a command with the same first byte it does
not appear to change their structure.

Responses appear to use their first byte to indicate which command they are responding to.

I suspect the app does not require a strict order of responses.

Example data flows generated by running the ThermoPro app can be seen in [these examples](./examples/driven-by-app)

One exception is to the normal data flow is that the thermometer appears to periodically send temperature updates (0x30
response) without needing a 0x30 command first.

## Observed Commands and Responses

> Follow the links to see more detailed information, including the format of the command and response

The following commands are *partially* understood

* [0x01 - initial setup](./commands/0x01-setup.md). Some kind of setup instruction. This must be sent or the device will
  not send 0x30 notifications
* [0x20 - set temperature units](./commands/0x20-set-temp-unit.md). Set the temperature units (degrees C or F) displayed
  on the thermometer.
* [0x23 - set probe profile](./commands/0x23-set-probe-profile.md). Set probe "profile" (which corresponds to alarm
  temperatures in the app)
* [0x24 - report probe profile](./commands/0x24-report-probe-profile). Report the probe's temperature profile back to
  the app.
* [0x25 - alternative temp report](./commands/0x25-alt-temp-report). Only seen once per flow, not clear why this is
  needed, given the presence of command 0x30.
* [0x30 - send temp report](./commands/0x30-send-temp-report.md). It's not clear why this command is needed, the
  thermometer will send 0x30 without any 0x30 commands

The following commands are not really understood yet:

* [0x26 - Unknown](./commands/0x26-unknown.md), only seen once per flow
* [0x41 - Unknown](./commands/0x41-unknown.md), only seen once per flow
* [0x27 alarm acknowledge](./commands/0x27-alarm-acknowledge.md) - Seems to be sent when alarm is triggered, but not yet
  tested
* [0xe0 - Error](./commands/0xe0-error.md)

### Summary table

> In these examples, the "junk" data is shown for responses. In other parts of the documentation, it is not.

| Command | Brief description    | Example command               | Example response                               |
|---------|----------------------|-------------------------------|------------------------------------------------|
| 0x01    | Setup                | `01 09 7032e2c1799db4d1c7 b1` | `01 01 0a 0c e2c1799db4d1c7b10020c1799db4d1c7` |
| 0x20    | Set temp units       | `20 01 0c 2d`                 | `20 00 20 2d0000917d0000271a0020480000200200`  | 
| 0x23    | Set probe profile    | `23 06 040607100000 4a`       | `23 02 0100 26 ffffff260000450200384c0200ffff` | 
| 0x30    | Send temp reports    | `30 00 30`                    | `30 0f 5a0c00ffffffffffff0325ffffffff c3 0140` |
| 0x26    | Maybe set mode?      | `26 00 26`                    | `26 05 0c0c5a030f af 0000071a0020480000200200` |
| 0x24    | Report probe profile | `24 01 04 29`                 | `24 06 04fa02900250 0c 00a1190020480000200200` |
| 0x41    | Unknown              | `41 00 41`                    | `41 02 3111 85 00917d0000c8190020480000200200` |
| 0x25    | Unknown              | `25 00 25`                    | `25 0e 0600ffffffffffff0223ffffffff 54 200200` |
| 0x27    | Alarm acknowledge?   | `27 00 27`                    | `27 00 27 000000917d0000da190020480000200200`  |
| 0xe0    | Error?               | (never observed being sent)   | `E0 02 3004 16 00917D0000E9190020480000200200` |

### Command and response observations

* All commands are exactly the right length to be TLVC
* Looking at the `tlv-check` tool, responses appear to contain one TLVC component, followed by junk data to pad up to
  20 bytes.
